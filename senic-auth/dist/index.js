"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const r=require("react/jsx-runtime"),h=require("react"),D=require("react-router-dom");let C=null;function q(e){C={...e,callbackPath:e.callbackPath||"/auth/callback",storageType:e.storageType||"local"}}function Y(){return w().storageType||"local"}function w(){if(!C)throw new Error("[SENIC Auth] Configuration not initialized. Wrap your app with <SenicAuthProvider>");return C}function R(){return`${w().supabaseUrl}/functions/v1`}function $(e){const t=w(),s=`${window.location.origin}${t.callbackPath}`,n=new URL(`${t.portalUrl}/login`);return n.searchParams.set("app",t.appId),n.searchParams.set("redirect_uri",s),n.searchParams.set("state",e),n.toString()}function E(){const e=Z();G(e);const t=$(e);window.location.href=t}function z(){const e=window.location.hash.substring(1),t=new URLSearchParams(e);return{accessToken:t.get("access_token"),state:t.get("state"),error:t.get("error")}}function j(){return Y()==="session"?sessionStorage:localStorage}function M(){const t=[navigator.userAgent,navigator.language,screen.width+"x"+screen.height,screen.colorDepth,Intl.DateTimeFormat().resolvedOptions().timeZone,navigator.hardwareConcurrency||0].join("|");let s=0;for(let n=0;n<t.length;n++){const a=t.charCodeAt(n);s=(s<<5)-s+a,s=s&s}return s.toString(36)}function N(e){const t=M(),s=JSON.stringify({token:e,fingerprint:t});j().setItem("senic_auth_token",s)}function A(){const t=j().getItem("senic_auth_token");if(!t)return null;try{const{token:s,fingerprint:n}=JSON.parse(t);return n!==M()?(console.warn("[SENIC Auth] Token fingerprint mismatch - possible token theft"),m(),null):s}catch{return m(),null}}function m(){localStorage.removeItem("senic_auth_token"),sessionStorage.removeItem("senic_auth_token")}function I(e){try{const s=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),n=decodeURIComponent(atob(s).split("").map(a=>"%"+("00"+a.charCodeAt(0).toString(16)).slice(-2)).join(""));return JSON.parse(n)}catch{return null}}function T(e){return e.exp*1e3<Date.now()}function _(){const e=A();if(!e)return null;const t=I(e);return t?T(t)?(m(),null):t:null}function Z(){return crypto.randomUUID()}function G(e){j().setItem("senic_auth_state",e)}function K(){return j().getItem("senic_auth_state")}function F(){localStorage.removeItem("senic_auth_state"),sessionStorage.removeItem("senic_auth_state")}function Q(e){const t=K();return e===t}async function X(e,t){const s=A();if(!s)return console.warn("[SENIC Auth] No token to refresh"),!1;try{const n=await fetch(`${e}/exchange-token`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({app_id:t})});if(!n.ok)return console.error("[SENIC Auth] Token refresh failed:",n.status),!1;const a=await n.json();return a.access_token?(N(a.access_token),console.log("[SENIC Auth] Token refreshed successfully"),!0):!1}catch(n){return console.error("[SENIC Auth] Token refresh error:",n),!1}}async function ee(e,t){const s=A();if(!s)return{valid:!1,shouldClear:!1};try{const n=await fetch(`${e}/exchange-token`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({app_id:t})});if(!n.ok){let i="unknown";try{const l=await n.json();if(i=l.error||"unknown",l.error==="force_logout")return console.warn("[SENIC Auth] Force logout triggered by admin - clearing token"),{valid:!1,shouldClear:!0,reason:"force_logout"}}catch{}return console.warn(`[SENIC Auth] Session validation failed (${i}) - clearing token`),{valid:!1,shouldClear:!0,reason:i}}const a=await n.json();return a.access_token?(N(a.access_token),{valid:!0,shouldClear:!1}):{valid:!1,shouldClear:!0,reason:"no_token_returned"}}catch(n){return console.warn("[SENIC Auth] Session validation network error:",n),{valid:!0,shouldClear:!1}}}const J=h.createContext(void 0);function p(){const e=h.useContext(J);if(!e)throw new Error("useAuth must be used within a SenicAuthProvider");return e}function te(e){return e>=100?"super_admin":e>=80?"admin":e>=60?"manager":e>=40?"editor":e>=20?"member":"viewer"}function re(e){return["starter","professional","business","enterprise"].includes(e)?e:"starter"}function ne(e){return["active","trialing","past_due","canceled","incomplete"].includes(e)?e:"active"}function se({children:e,appId:t,portalUrl:s,supabaseUrl:n,callbackPath:a,storageType:i,onLogout:l}){q({appId:t,portalUrl:s,supabaseUrl:n,callbackPath:a,storageType:i});const[d,u]=h.useState(null),[S,f]=h.useState(!0),b=o=>o?{id:o.sub,email:o.email,name:o.full_name||o.email.split("@")[0],displayName:o.full_name||o.email.split("@")[0],avatarUrl:o.avatar_url,organizationId:o.organization_id,organizationName:o.organization_name,organizationSlug:o.organization_slug,role:te(o.app_role_level),roleLevel:o.app_role_level,isOwner:o.is_owner,permissions:o.permissions||[],enabledModules:o.enabled_modules||[],subscriptionPlan:re(o.subscription_plan),subscriptionStatus:ne(o.subscription_status),planFeatures:o.plan_features||[],planLimits:o.plan_limits||{},isPlatformAdmin:o.is_platform_admin||!1}:null,v=()=>{try{const o=_();u(b(o))}catch(o){console.error("[SENIC Auth] Error refreshing auth:",o),u(null)}},g=async()=>{try{const o=w(),k=R(),{valid:y,shouldClear:x,reason:P}=await ee(k,o.appId);if(x)console.log(`[SENIC Auth] Session invalid (${P}) - clearing and redirecting to login`),m(),u(null);else if(y){const L=_();u(b(L))}}catch(o){console.error("[SENIC Auth] Session validation error:",o)}finally{f(!1)}},H=async()=>{if(new URLSearchParams(window.location.search).get("verified")==="true"){console.log("[SENIC Auth] Detected ?verified=true - refreshing token for updated claims");const y=new URL(window.location.href);y.searchParams.delete("verified"),window.history.replaceState({},"",y.toString());try{const x=w(),P=R();if(await X(P,x.appId)){const W=_();u(b(W)),console.log("[SENIC Auth] Token refreshed with updated claims")}}catch(x){console.error("[SENIC Auth] Failed to refresh token after verification:",x)}}};h.useEffect(()=>{v(),g(),H()},[]),h.useEffect(()=>{const k=setInterval(()=>{d&&(console.log("[SENIC Auth] Heartbeat - validating session"),g())},9e5);return()=>clearInterval(k)},[d]);const U={user:d,isAuthenticated:!!d,isLoading:S,logout:()=>{m(),u(null),l?l():setTimeout(()=>{E()},500)},loginViaPortal:()=>{E()},refreshAuth:v};return r.jsx(J.Provider,{value:U,children:e})}function V(){const{user:e,isAuthenticated:t}=p();if(!t||!e)return{plan:null,status:null,features:[],limits:{},hasFeature:()=>!1,checkLimit:()=>!1,isActive:!1};const s=i=>e.planFeatures.includes(i),n=(i,l)=>{const c=e.planLimits[i];return c==null||c===-1?!0:l<c},a=e.subscriptionStatus==="active"||e.subscriptionStatus==="trialing";return{plan:e.subscriptionPlan,status:e.subscriptionStatus,features:e.planFeatures,limits:e.planLimits,hasFeature:s,checkLimit:n,isActive:a}}function B(){const{user:e,isAuthenticated:t}=p();if(!t||!e)return{permissions:[],modules:[],role:null,roleLevel:100,isOwner:!1,hasPermission:()=>!1,hasModule:()=>!1,canAccess:()=>!1,isAdminLevel:!1,isSuperAdmin:!1};const s=c=>e.isOwner||e.role==="super_admin"?!0:e.permissions.includes(c),n=c=>e.isOwner||e.role==="super_admin"?!0:e.enabledModules.includes(c),a=(c,d)=>{const u=s(c);return d?u&&n(d):u},i=e.role==="admin"||e.role==="super_admin",l=e.role==="super_admin";return{permissions:e.permissions,modules:e.enabledModules,role:e.role,roleLevel:e.roleLevel,isOwner:e.isOwner,hasPermission:s,hasModule:n,canAccess:a,isAdminLevel:i,isSuperAdmin:l}}function oe(){const{user:e,isLoading:t}=p();return{isPlatformAdmin:(e==null?void 0:e.isPlatformAdmin)??!1,isLoading:t,user:e}}function ae({logoUrl:e}){return r.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:r.jsxs("div",{className:"text-center",children:[e&&r.jsx("img",{src:e,alt:"Logo",className:"h-16 mx-auto mb-4 animate-pulse"}),r.jsx("p",{className:"text-gray-600",children:"Completing authentication..."})]})})}function ie({error:e,onRetry:t}){return r.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:r.jsxs("div",{className:"bg-white rounded-lg border shadow-lg p-8 max-w-md text-center",children:[r.jsx("h1",{className:"text-xl font-semibold text-gray-800 mb-2",children:"Authentication Failed"}),r.jsx("p",{className:"text-gray-600 mb-6",children:e}),r.jsx("button",{onClick:t,className:"w-full px-4 py-3 rounded-lg font-medium text-white bg-blue-600 hover:bg-blue-700 transition-colors",children:"Back to Login"})]})})}function le({logoUrl:e,redirectTo:t="/",errorRedirectTo:s="/login",LoadingComponent:n,ErrorComponent:a}){const i=D.useNavigate(),{refreshAuth:l}=p(),[c,d]=h.useState(null);h.useEffect(()=>{(async()=>{try{const{accessToken:f,state:b,error:v}=z();if(v)throw new Error(v);if(!f)throw new Error("No access token received");if(!Q(b))throw new Error("Invalid state parameter - possible CSRF attack");const g=I(f);if(!g)throw new Error("Invalid token format");if(T(g))throw new Error("Token has expired");if(!g.master_auth)throw new Error("Invalid token - not from Master Auth");N(f),F(),window.history.replaceState(null,"",window.location.pathname),l(),i(t,{replace:!0})}catch(f){console.error("[SENIC Auth] Callback error:",f),d(f instanceof Error?f.message:"Authentication failed"),F()}})()},[i,l,t]);const u=()=>{i(s,{replace:!0})};return c?a?r.jsx(a,{error:c,onRetry:u}):r.jsx(ie,{error:c,onRetry:u}):n?r.jsx(n,{}):r.jsx(ae,{logoUrl:e})}function O(){return r.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:r.jsxs("div",{className:"bg-white rounded-lg border shadow-lg p-8 max-w-md text-center",children:[r.jsx("h1",{className:"text-xl font-semibold text-gray-800 mb-2",children:"Access Denied"}),r.jsx("p",{className:"text-gray-600",children:"You don't have permission to access this resource."})]})})}function ce(){return r.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:r.jsxs("div",{className:"text-center",children:[r.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"}),r.jsx("p",{className:"text-gray-600 mt-4",children:"Loading..."})]})})}function ue({children:e,requirePermission:t,requireModule:s,redirectTo:n,UnauthorizedComponent:a,LoadingComponent:i}){const{isAuthenticated:l,isLoading:c,loginViaPortal:d}=p(),{hasPermission:u,hasModule:S}=B();return c?i?r.jsx(i,{}):r.jsx(ce,{}):l?t&&!u(t)?a?r.jsx(a,{}):r.jsx(O,{}):s&&!S(s)?a?r.jsx(a,{}):r.jsx(O,{}):r.jsx(r.Fragment,{children:e}):n?r.jsx(D.Navigate,{to:n,replace:!0}):(d(),null)}function de({feature:e,currentPlan:t,upgradeUrl:s,message:n}){const a=n||`Upgrade your plan to access ${e}`;return r.jsxs("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-6 text-center",children:[r.jsx("div",{className:"text-blue-600 mb-2",children:r.jsx("svg",{className:"w-12 h-12 mx-auto",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:r.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"})})}),r.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-2",children:"Feature Locked"}),r.jsx("p",{className:"text-gray-600 mb-4",children:a}),r.jsxs("p",{className:"text-sm text-gray-500 mb-4",children:["Current plan: ",t]}),s&&r.jsx("a",{href:s,className:"inline-block px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors",children:"Upgrade Now"})]})}function fe({feature:e,children:t,UpgradeComponent:s,upgradeUrl:n,message:a}){const{hasFeature:i,plan:l}=V();return i(e)?r.jsx(r.Fragment,{children:t}):s?r.jsx(s,{feature:e,currentPlan:l||"free"}):r.jsx(de,{feature:e,currentPlan:l||"free",upgradeUrl:n,message:a})}exports.AuthCallback=le;exports.ProtectedRoute=ue;exports.SenicAuthProvider=se;exports.UpgradePrompt=fe;exports.buildAuthPortalUrl=$;exports.clearToken=m;exports.getCurrentUser=_;exports.getToken=A;exports.isTokenExpired=T;exports.parseCallbackHash=z;exports.parseJwtPayload=I;exports.redirectToAuthPortal=E;exports.storeToken=N;exports.useAuth=p;exports.usePermissions=B;exports.usePlatformAdmin=oe;exports.useSubscription=V;
//# sourceMappingURL=index.js.map
