{"version":3,"file":"index.js","sources":["../src/config.ts","../src/utils/token.ts","../src/context/AuthContext.tsx","../src/hooks/useSubscription.ts","../src/hooks/usePermissions.ts","../src/hooks/usePlatformAdmin.ts","../src/components/AuthCallback.tsx","../src/components/ProtectedRoute.tsx","../src/components/UpgradePrompt.tsx"],"sourcesContent":["// ============================================================\n// Configuration - SENIC Auth Package\n// ============================================================\n\nimport { SenicAuthConfig } from './utils/types';\nimport { generateState, storeAuthState } from './utils/token';\n\nlet _config: SenicAuthConfig | null = null;\n\n/**\n * Initialize SENIC Auth configuration\n */\nexport function initConfig(config: SenicAuthConfig): void {\n  _config = {\n    ...config,\n    callbackPath: config.callbackPath || '/auth/callback',\n    storageType: config.storageType || 'local',\n  };\n}\n\n/**\n * Get configured storage type\n */\nexport function getStorageType(): 'local' | 'session' {\n  const config = getConfig();\n  return config.storageType || 'local';\n}\n\n/**\n * Get current configuration\n */\nexport function getConfig(): SenicAuthConfig {\n  if (!_config) {\n    throw new Error('[SENIC Auth] Configuration not initialized. Wrap your app with <SenicAuthProvider>');\n  }\n  return _config;\n}\n\n/**\n * Get Edge Functions URL from Supabase root URL\n * Package internally appends /functions/v1\n */\nexport function getEdgeFunctionsUrl(): string {\n  const config = getConfig();\n  return `${config.supabaseUrl}/functions/v1`;\n}\n\n/**\n * Build the redirect URL to auth portal\n */\nexport function buildAuthPortalUrl(state: string): string {\n  const config = getConfig();\n  const redirectUri = `${window.location.origin}${config.callbackPath}`;\n\n  const url = new URL(`${config.portalUrl}/login`);\n  url.searchParams.set('app', config.appId);\n  url.searchParams.set('redirect_uri', redirectUri);\n  url.searchParams.set('state', state);\n\n  return url.toString();\n}\n\n/**\n * Redirect to auth portal for login\n */\nexport function redirectToAuthPortal(): void {\n  const state = generateState();\n  storeAuthState(state);\n\n  const authUrl = buildAuthPortalUrl(state);\n  window.location.href = authUrl;\n}\n\n/**\n * Parse hash params from callback URL\n */\nexport function parseCallbackHash(): {\n  accessToken: string | null;\n  state: string | null;\n  error: string | null;\n} {\n  const hash = window.location.hash.substring(1);\n  const params = new URLSearchParams(hash);\n\n  return {\n    accessToken: params.get('access_token'),\n    state: params.get('state'),\n    error: params.get('error'),\n  };\n}\n","// ============================================================\n// Token Management - SENIC Auth Package\n// Handles secure token storage with browser fingerprinting\n// ============================================================\n\nimport { MasterAuthToken } from './types';\nimport { getStorageType } from '../config';\n\n/**\n * Get the appropriate storage based on configuration\n */\nfunction getStorage(): Storage {\n  return getStorageType() === 'session' ? sessionStorage : localStorage;\n}\n\n/**\n * Generate browser fingerprint for token binding\n * SECURITY: Binds token to this specific browser instance\n */\nfunction generateFingerprint(): string {\n  const components = [\n    navigator.userAgent,\n    navigator.language,\n    screen.width + 'x' + screen.height,\n    screen.colorDepth,\n    Intl.DateTimeFormat().resolvedOptions().timeZone,\n    navigator.hardwareConcurrency || 0,\n  ];\n\n  // Simple hash function\n  const str = components.join('|');\n  let hash = 0;\n  for (let i = 0; i < str.length; i++) {\n    const char = str.charCodeAt(i);\n    hash = ((hash << 5) - hash) + char;\n    hash = hash & hash; // Convert to 32bit integer\n  }\n  return hash.toString(36);\n}\n\n/**\n * Store Master Auth token with browser binding\n * SECURITY:\n * - Storage type configurable (localStorage or sessionStorage)\n * - Fingerprint binding: token only valid in this browser\n */\nexport function storeToken(token: string): void {\n  const fingerprint = generateFingerprint();\n  const boundToken = JSON.stringify({ token, fingerprint });\n  getStorage().setItem('senic_auth_token', boundToken);\n}\n\n/**\n * Get stored Master Auth token (with fingerprint verification)\n * Returns null if fingerprint doesn't match (stolen token detection)\n */\nexport function getToken(): string | null {\n  const storage = getStorage();\n  const stored = storage.getItem('senic_auth_token');\n  if (!stored) return null;\n\n  try {\n    const { token, fingerprint } = JSON.parse(stored);\n\n    // SECURITY: Verify token was issued to this browser\n    if (fingerprint !== generateFingerprint()) {\n      console.warn('[SENIC Auth] Token fingerprint mismatch - possible token theft');\n      clearToken();\n      return null;\n    }\n\n    return token;\n  } catch {\n    // Invalid format - clear it\n    clearToken();\n    return null;\n  }\n}\n\n/**\n * Clear Master Auth token\n */\nexport function clearToken(): void {\n  // Clear from both storages to handle storage type changes\n  localStorage.removeItem('senic_auth_token');\n  sessionStorage.removeItem('senic_auth_token');\n}\n\n/**\n * Parse JWT payload (without verification - already verified by edge function)\n */\nexport function parseJwtPayload(token: string): MasterAuthToken | null {\n  try {\n    const base64Url = token.split('.')[1];\n    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');\n    const jsonPayload = decodeURIComponent(\n      atob(base64)\n        .split('')\n        .map((c) => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))\n        .join('')\n    );\n    return JSON.parse(jsonPayload);\n  } catch {\n    return null;\n  }\n}\n\n/**\n * Check if token is expired\n */\nexport function isTokenExpired(token: MasterAuthToken): boolean {\n  return token.exp * 1000 < Date.now();\n}\n\n/**\n * Get current user from stored token\n */\nexport function getCurrentUser(): MasterAuthToken | null {\n  const token = getToken();\n  if (!token) return null;\n\n  const payload = parseJwtPayload(token);\n  if (!payload) return null;\n\n  if (isTokenExpired(payload)) {\n    clearToken();\n    return null;\n  }\n\n  return payload;\n}\n\n/**\n * Generate a random state for CSRF protection\n */\nexport function generateState(): string {\n  return crypto.randomUUID();\n}\n\n/**\n * Store auth state for CSRF verification\n * Uses same storage as token (localStorage or sessionStorage based on config)\n */\nexport function storeAuthState(state: string): void {\n  // Use same storage as token for consistency\n  getStorage().setItem('senic_auth_state', state);\n}\n\n/**\n * Get stored auth state\n */\nexport function getAuthState(): string | null {\n  return getStorage().getItem('senic_auth_state');\n}\n\n/**\n * Clear auth state from storage\n */\nexport function clearAuthState(): void {\n  // Clear from both storages to handle storage type changes\n  localStorage.removeItem('senic_auth_state');\n  sessionStorage.removeItem('senic_auth_state');\n}\n\n/**\n * Verify state matches what we stored (CSRF protection)\n */\nexport function verifyState(state: string | null): boolean {\n  const savedState = getAuthState();\n  return state === savedState;\n}\n\n/**\n * Refresh token by calling exchange-token endpoint\n * Used when user verifies email and needs updated claims\n */\nexport async function refreshTokenFromServer(\n  edgeFunctionsUrl: string,\n  appId: string\n): Promise<boolean> {\n  const currentToken = getToken();\n  if (!currentToken) {\n    console.warn('[SENIC Auth] No token to refresh');\n    return false;\n  }\n\n  try {\n    const response = await fetch(`${edgeFunctionsUrl}/exchange-token`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'Authorization': `Bearer ${currentToken}`,\n      },\n      body: JSON.stringify({ app_id: appId }),\n    });\n\n    if (!response.ok) {\n      console.error('[SENIC Auth] Token refresh failed:', response.status);\n      return false;\n    }\n\n    const data = await response.json();\n    if (data.access_token) {\n      storeToken(data.access_token);\n      console.log('[SENIC Auth] Token refreshed successfully');\n      return true;\n    }\n\n    return false;\n  } catch (error) {\n    console.error('[SENIC Auth] Token refresh error:', error);\n    return false;\n  }\n}\n\n/**\n * Validate session with server\n * SECURITY: Called on app mount to ensure user still exists in database\n * Catches: deleted users, revoked access, deactivated accounts, force logout\n */\nexport async function validateSessionWithServer(\n  edgeFunctionsUrl: string,\n  appId: string\n): Promise<{ valid: boolean; shouldClear: boolean; reason?: string }> {\n  const currentToken = getToken();\n  if (!currentToken) {\n    // No token = not logged in (valid state, no need to clear)\n    return { valid: false, shouldClear: false };\n  }\n\n  try {\n    const response = await fetch(`${edgeFunctionsUrl}/exchange-token`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'Authorization': `Bearer ${currentToken}`,\n      },\n      body: JSON.stringify({ app_id: appId }),\n    });\n\n    if (!response.ok) {\n      // Parse error to get specific reason\n      let reason = 'unknown';\n      try {\n        const errorData = await response.json();\n        reason = errorData.error || 'unknown';\n\n        // Handle specific error codes\n        if (errorData.error === 'force_logout') {\n          console.warn('[SENIC Auth] Force logout triggered by admin - clearing token');\n          return { valid: false, shouldClear: true, reason: 'force_logout' };\n        }\n      } catch {\n        // Failed to parse error response\n      }\n\n      console.warn(`[SENIC Auth] Session validation failed (${reason}) - clearing token`);\n      return { valid: false, shouldClear: true, reason };\n    }\n\n    const data = await response.json();\n    if (data.access_token) {\n      // Refresh the token while we're at it (get latest claims)\n      storeToken(data.access_token);\n      return { valid: true, shouldClear: false };\n    }\n\n    return { valid: false, shouldClear: true, reason: 'no_token_returned' };\n  } catch (error) {\n    // Network error - don't clear token (might be offline)\n    console.warn('[SENIC Auth] Session validation network error:', error);\n    return { valid: true, shouldClear: false };\n  }\n}\n","// ============================================================\n// Auth Context - SENIC Auth Package\n// Main authentication provider with user state management\n// ============================================================\n\nimport { createContext, useContext, useState, useEffect, ReactNode } from 'react';\nimport { SenicUser, SenicAuthConfig, UserRole, SubscriptionPlan, SubscriptionStatus, StorageType } from '../utils/types';\nimport { getCurrentUser, clearToken, refreshTokenFromServer, validateSessionWithServer } from '../utils/token';\nimport { initConfig, redirectToAuthPortal, getEdgeFunctionsUrl, getConfig } from '../config';\n\n// ============================================================\n// Types\n// ============================================================\n\ninterface AuthContextType {\n  user: SenicUser | null;\n  isAuthenticated: boolean;\n  isLoading: boolean;\n  logout: () => void;\n  loginViaPortal: () => void;\n  refreshAuth: () => void;\n}\n\n// ============================================================\n// Context\n// ============================================================\n\nconst AuthContext = createContext<AuthContextType | undefined>(undefined);\n\n/**\n * Hook to access auth context\n */\nexport function useAuth(): AuthContextType {\n  const context = useContext(AuthContext);\n  if (!context) {\n    throw new Error('useAuth must be used within a SenicAuthProvider');\n  }\n  return context;\n}\n\n// ============================================================\n// Helpers\n// ============================================================\n\n/**\n * Map role level to UserRole enum\n * Levels: super_admin=100, admin=80, manager=60, editor=40, member=20, viewer=10\n */\nfunction mapRoleLevelToRole(level: number): UserRole {\n  if (level >= 100) return 'super_admin';\n  if (level >= 80) return 'admin';\n  if (level >= 60) return 'manager';\n  if (level >= 40) return 'editor';\n  if (level >= 20) return 'member';\n  return 'viewer';\n}\n\n/**\n * Map subscription plan string to typed enum\n */\nfunction mapSubscriptionPlan(plan: string): SubscriptionPlan {\n  const validPlans: SubscriptionPlan[] = ['starter', 'professional', 'business', 'enterprise'];\n  return validPlans.includes(plan as SubscriptionPlan)\n    ? (plan as SubscriptionPlan)\n    : 'starter';\n}\n\n/**\n * Map subscription status string to typed enum\n */\nfunction mapSubscriptionStatus(status: string): SubscriptionStatus {\n  const validStatuses: SubscriptionStatus[] = ['active', 'trialing', 'past_due', 'canceled', 'incomplete'];\n  return validStatuses.includes(status as SubscriptionStatus)\n    ? (status as SubscriptionStatus)\n    : 'active';\n}\n\n// ============================================================\n// Provider\n// ============================================================\n\ninterface SenicAuthProviderProps {\n  children: ReactNode;\n  appId: string;\n  portalUrl: string;\n  supabaseUrl: string;\n  callbackPath?: string;\n  storageType?: StorageType; // 'local' (default) or 'session' (for banking/payment apps)\n  onLogout?: () => void;\n}\n\nexport function SenicAuthProvider({\n  children,\n  appId,\n  portalUrl,\n  supabaseUrl,\n  callbackPath,\n  storageType,\n  onLogout,\n}: SenicAuthProviderProps): JSX.Element {\n  // Initialize config SYNCHRONOUSLY before any hooks run\n  // This ensures config is ready before AuthCallback or any other component tries to use it\n  // Previously this was in useEffect which caused a race condition on callback page\n  const configRef = { appId, portalUrl, supabaseUrl, callbackPath, storageType };\n  initConfig(configRef);\n\n  const [user, setUser] = useState<SenicUser | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n\n  /**\n   * Build SenicUser from MasterAuthToken\n   * Field names must match what exchange-token edge function returns\n   */\n  const buildUser = (masterAuthUser: ReturnType<typeof getCurrentUser>): SenicUser | null => {\n    if (!masterAuthUser) return null;\n\n    return {\n      id: masterAuthUser.sub,\n      email: masterAuthUser.email,\n      name: masterAuthUser.full_name || masterAuthUser.email.split('@')[0],\n      displayName: masterAuthUser.full_name || masterAuthUser.email.split('@')[0],\n      avatarUrl: masterAuthUser.avatar_url,\n      organizationId: masterAuthUser.organization_id,\n      organizationName: masterAuthUser.organization_name,\n      organizationSlug: masterAuthUser.organization_slug,\n      role: mapRoleLevelToRole(masterAuthUser.app_role_level),\n      roleLevel: masterAuthUser.app_role_level,\n      isOwner: masterAuthUser.is_owner,\n      permissions: masterAuthUser.permissions || [],\n      enabledModules: masterAuthUser.enabled_modules || [],\n      subscriptionPlan: mapSubscriptionPlan(masterAuthUser.subscription_plan),\n      subscriptionStatus: mapSubscriptionStatus(masterAuthUser.subscription_status),\n      planFeatures: masterAuthUser.plan_features || [],\n      planLimits: masterAuthUser.plan_limits || {},\n      isPlatformAdmin: masterAuthUser.is_platform_admin || false,\n    };\n  };\n\n  /**\n   * Refresh auth state from stored token (local only, no server call)\n   */\n  const refreshAuth = () => {\n    try {\n      const masterAuthUser = getCurrentUser();\n      setUser(buildUser(masterAuthUser));\n    } catch (error) {\n      console.error('[SENIC Auth] Error refreshing auth:', error);\n      setUser(null);\n    }\n  };\n\n  /**\n   * Validate session with server on mount\n   * SECURITY: Ensures user still exists in database (catches deleted/revoked users)\n   */\n  const validateSession = async () => {\n    try {\n      const config = getConfig();\n      const edgeFunctionsUrl = getEdgeFunctionsUrl();\n\n      const { valid, shouldClear, reason } = await validateSessionWithServer(edgeFunctionsUrl, config.appId);\n\n      if (shouldClear) {\n        console.log(`[SENIC Auth] Session invalid (${reason}) - clearing and redirecting to login`);\n        clearToken();\n        setUser(null);\n      } else if (valid) {\n        // Refresh user from potentially updated token\n        const masterAuthUser = getCurrentUser();\n        setUser(buildUser(masterAuthUser));\n      }\n    } catch (error) {\n      console.error('[SENIC Auth] Session validation error:', error);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  /**\n   * Handle ?verified=true - refresh token to get updated claims\n   */\n  const handleVerifiedParam = async () => {\n    const urlParams = new URLSearchParams(window.location.search);\n    const verified = urlParams.get('verified');\n\n    if (verified === 'true') {\n      console.log('[SENIC Auth] Detected ?verified=true - refreshing token for updated claims');\n\n      // Clean URL by removing the param\n      const url = new URL(window.location.href);\n      url.searchParams.delete('verified');\n      window.history.replaceState({}, '', url.toString());\n\n      // Refresh token from server to get updated claims (e.g., is_verified = true)\n      try {\n        const config = getConfig();\n        const edgeFunctionsUrl = getEdgeFunctionsUrl();\n        const success = await refreshTokenFromServer(edgeFunctionsUrl, config.appId);\n\n        if (success) {\n          // Reload user from new token\n          const masterAuthUser = getCurrentUser();\n          setUser(buildUser(masterAuthUser));\n          console.log('[SENIC Auth] Token refreshed with updated claims');\n        }\n      } catch (error) {\n        console.error('[SENIC Auth] Failed to refresh token after verification:', error);\n      }\n    }\n  };\n\n  // Initialize on mount - validate session with server\n  useEffect(() => {\n    // First do a quick local check to show UI faster\n    refreshAuth();\n\n    // Then validate with server (catches deleted/revoked users)\n    validateSession();\n\n    // Handle ?verified=true if present\n    handleVerifiedParam();\n  }, []);\n\n  // Periodic session validation (heartbeat)\n  // SECURITY: Catches deleted users, revoked tokens, and breaking changes\n  // even when user leaves browser tab open for extended periods\n  useEffect(() => {\n    const HEARTBEAT_INTERVAL = 15 * 60 * 1000; // 15 minutes\n\n    const interval = setInterval(() => {\n      // Only validate if user appears to be logged in\n      if (user) {\n        console.log('[SENIC Auth] Heartbeat - validating session');\n        validateSession();\n      }\n    }, HEARTBEAT_INTERVAL);\n\n    return () => clearInterval(interval);\n  }, [user]);\n\n  /**\n   * Redirect to auth portal for login\n   */\n  const loginViaPortal = () => {\n    redirectToAuthPortal();\n  };\n\n  /**\n   * Logout - clear token and optionally redirect\n   */\n  const logout = () => {\n    clearToken();\n    setUser(null);\n\n    // Call custom logout handler if provided\n    if (onLogout) {\n      onLogout();\n    } else {\n      // Default: redirect to portal\n      setTimeout(() => {\n        redirectToAuthPortal();\n      }, 500);\n    }\n  };\n\n  const value: AuthContextType = {\n    user,\n    isAuthenticated: !!user,\n    isLoading,\n    logout,\n    loginViaPortal,\n    refreshAuth,\n  };\n\n  return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;\n}\n","// ============================================================\n// useSubscription Hook - SENIC Auth Package\n// Access subscription plan, features, and limits\n// ============================================================\n\nimport { useAuth } from '../context/AuthContext';\nimport { SubscriptionPlan, SubscriptionStatus } from '../utils/types';\n\nexport interface UseSubscriptionReturn {\n  plan: SubscriptionPlan | null;\n  status: SubscriptionStatus | null;\n  features: string[];\n  limits: Record<string, number>;\n  hasFeature: (feature: string) => boolean;\n  checkLimit: (limitKey: string, currentValue: number) => boolean;\n  isActive: boolean;\n}\n\n/**\n * Hook to access subscription information\n */\nexport function useSubscription(): UseSubscriptionReturn {\n  const { user, isAuthenticated } = useAuth();\n\n  if (!isAuthenticated || !user) {\n    return {\n      plan: null,\n      status: null,\n      features: [],\n      limits: {},\n      hasFeature: () => false,\n      checkLimit: () => false,\n      isActive: false,\n    };\n  }\n\n  /**\n   * Check if user has a specific feature\n   */\n  const hasFeature = (feature: string): boolean => {\n    return user.planFeatures.includes(feature);\n  };\n\n  /**\n   * Check if current value is within limit\n   * Returns true if within limit or no limit exists\n   */\n  const checkLimit = (limitKey: string, currentValue: number): boolean => {\n    const limit = user.planLimits[limitKey];\n    if (limit === undefined || limit === null) return true; // No limit = unlimited\n    if (limit === -1) return true; // -1 = unlimited\n    return currentValue < limit;\n  };\n\n  /**\n   * Check if subscription is active\n   */\n  const isActive = user.subscriptionStatus === 'active' || user.subscriptionStatus === 'trialing';\n\n  return {\n    plan: user.subscriptionPlan,\n    status: user.subscriptionStatus,\n    features: user.planFeatures,\n    limits: user.planLimits,\n    hasFeature,\n    checkLimit,\n    isActive,\n  };\n}\n","// ============================================================\n// usePermissions Hook - SENIC Auth Package\n// Access permissions, modules, and role information\n// ============================================================\n\nimport { useAuth } from '../context/AuthContext';\nimport { UserRole } from '../utils/types';\n\nexport interface UsePermissionsReturn {\n  permissions: string[];\n  modules: string[];\n  role: UserRole | null;\n  roleLevel: number;\n  isOwner: boolean;\n  hasPermission: (permission: string) => boolean;\n  hasModule: (module: string) => boolean;\n  canAccess: (permission: string, module?: string) => boolean;\n  isAdminLevel: boolean;\n  isSuperAdmin: boolean;\n}\n\n/**\n * Hook to access permissions and role information\n */\nexport function usePermissions(): UsePermissionsReturn {\n  const { user, isAuthenticated } = useAuth();\n\n  if (!isAuthenticated || !user) {\n    return {\n      permissions: [],\n      modules: [],\n      role: null,\n      roleLevel: 100,\n      isOwner: false,\n      hasPermission: () => false,\n      hasModule: () => false,\n      canAccess: () => false,\n      isAdminLevel: false,\n      isSuperAdmin: false,\n    };\n  }\n\n  /**\n   * Check if user has a specific permission\n   */\n  const hasPermission = (permission: string): boolean => {\n    // Owners and super_admins have all permissions\n    if (user.isOwner || user.role === 'super_admin') return true;\n    return user.permissions.includes(permission);\n  };\n\n  /**\n   * Check if user has access to a specific module\n   */\n  const hasModule = (module: string): boolean => {\n    // Owners and super_admins have all modules\n    if (user.isOwner || user.role === 'super_admin') return true;\n    return user.enabledModules.includes(module);\n  };\n\n  /**\n   * Check if user can access a resource (permission + optional module)\n   */\n  const canAccess = (permission: string, module?: string): boolean => {\n    const hasRequiredPermission = hasPermission(permission);\n    if (!module) return hasRequiredPermission;\n    return hasRequiredPermission && hasModule(module);\n  };\n\n  /**\n   * Check if user is admin level (admin or super_admin)\n   */\n  const isAdminLevel = user.role === 'admin' || user.role === 'super_admin';\n\n  /**\n   * Check if user is super admin\n   */\n  const isSuperAdmin = user.role === 'super_admin';\n\n  return {\n    permissions: user.permissions,\n    modules: user.enabledModules,\n    role: user.role,\n    roleLevel: user.roleLevel,\n    isOwner: user.isOwner,\n    hasPermission,\n    hasModule,\n    canAccess,\n    isAdminLevel,\n    isSuperAdmin,\n  };\n}\n","// ============================================================\n// Platform Admin Hook - SENIC Auth Package\n// ============================================================\n\nimport { useAuth } from '../context/AuthContext';\n\n/**\n * Hook to check if current user is a Platform Admin\n *\n * Platform Admin = super_admin role (level 100) + member of 'senic' organization\n *\n * Uses the is_platform_admin claim from JWT which is set by the\n * custom_access_token_hook in Master Auth database.\n */\nexport function usePlatformAdmin() {\n  const { user, isLoading } = useAuth();\n\n  return {\n    /** Whether the current user is a platform admin */\n    isPlatformAdmin: user?.isPlatformAdmin ?? false,\n    /** Whether authentication is still loading */\n    isLoading,\n    /** Current user object */\n    user,\n  };\n}\n\nexport type UsePlatformAdminReturn = ReturnType<typeof usePlatformAdmin>;\n","// ============================================================\n// AuthCallback Component - SENIC Auth Package\n// Handles redirect from Master Auth Portal\n// ============================================================\n\nimport { useEffect, useState } from 'react';\nimport { useNavigate } from 'react-router-dom';\nimport { useAuth } from '../hooks/useAuth';\nimport {\n  parseJwtPayload,\n  storeToken,\n  isTokenExpired,\n  verifyState,\n  clearAuthState,\n} from '../utils/token';\nimport { parseCallbackHash } from '../config';\n\ninterface AuthCallbackProps {\n  /**\n   * Custom logo URL (optional)\n   */\n  logoUrl?: string;\n  /**\n   * Custom redirect path after successful auth (default: '/')\n   */\n  redirectTo?: string;\n  /**\n   * Custom error redirect path (default: '/login')\n   */\n  errorRedirectTo?: string;\n  /**\n   * Custom loading component\n   */\n  LoadingComponent?: React.ComponentType;\n  /**\n   * Custom error component\n   */\n  ErrorComponent?: React.ComponentType<{ error: string; onRetry: () => void }>;\n}\n\n/**\n * Default loading component\n */\nfunction DefaultLoading({ logoUrl }: { logoUrl?: string }) {\n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-gray-50\">\n      <div className=\"text-center\">\n        {logoUrl && (\n          <img\n            src={logoUrl}\n            alt=\"Logo\"\n            className=\"h-16 mx-auto mb-4 animate-pulse\"\n          />\n        )}\n        <p className=\"text-gray-600\">Completing authentication...</p>\n      </div>\n    </div>\n  );\n}\n\n/**\n * Default error component\n */\nfunction DefaultError({ error, onRetry }: { error: string; onRetry: () => void }) {\n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-gray-50\">\n      <div className=\"bg-white rounded-lg border shadow-lg p-8 max-w-md text-center\">\n        <h1 className=\"text-xl font-semibold text-gray-800 mb-2\">Authentication Failed</h1>\n        <p className=\"text-gray-600 mb-6\">{error}</p>\n        <button\n          onClick={onRetry}\n          className=\"w-full px-4 py-3 rounded-lg font-medium text-white bg-blue-600 hover:bg-blue-700 transition-colors\"\n        >\n          Back to Login\n        </button>\n      </div>\n    </div>\n  );\n}\n\n/**\n * AuthCallback component - handles OAuth callback\n */\nexport function AuthCallback({\n  logoUrl,\n  redirectTo = '/',\n  errorRedirectTo = '/login',\n  LoadingComponent,\n  ErrorComponent,\n}: AuthCallbackProps) {\n  const navigate = useNavigate();\n  const { refreshAuth } = useAuth();\n  const [error, setError] = useState<string | null>(null);\n\n  useEffect(() => {\n    const handleCallback = async () => {\n      try {\n        // Parse hash params\n        const { accessToken, state, error: callbackError } = parseCallbackHash();\n\n        // Check for errors\n        if (callbackError) {\n          throw new Error(callbackError);\n        }\n\n        // Verify we have a token\n        if (!accessToken) {\n          throw new Error('No access token received');\n        }\n\n        // Verify state (CSRF protection)\n        if (!verifyState(state)) {\n          throw new Error('Invalid state parameter - possible CSRF attack');\n        }\n\n        // Parse and validate token\n        const payload = parseJwtPayload(accessToken);\n        if (!payload) {\n          throw new Error('Invalid token format');\n        }\n\n        if (isTokenExpired(payload)) {\n          throw new Error('Token has expired');\n        }\n\n        // Verify it's a Master Auth token\n        if (!payload.master_auth) {\n          throw new Error('Invalid token - not from Master Auth');\n        }\n\n        // Store the token\n        storeToken(accessToken);\n\n        // Clear auth state\n        clearAuthState();\n\n        // Clear the hash from URL (security)\n        window.history.replaceState(null, '', window.location.pathname);\n\n        // Refresh AuthContext to pick up the new token\n        refreshAuth();\n\n        // Navigate to destination\n        navigate(redirectTo, { replace: true });\n      } catch (err) {\n        console.error('[SENIC Auth] Callback error:', err);\n        setError(err instanceof Error ? err.message : 'Authentication failed');\n        clearAuthState();\n      }\n    };\n\n    handleCallback();\n  }, [navigate, refreshAuth, redirectTo]);\n\n  const handleRetry = () => {\n    navigate(errorRedirectTo, { replace: true });\n  };\n\n  if (error) {\n    if (ErrorComponent) {\n      return <ErrorComponent error={error} onRetry={handleRetry} />;\n    }\n    return <DefaultError error={error} onRetry={handleRetry} />;\n  }\n\n  if (LoadingComponent) {\n    return <LoadingComponent />;\n  }\n\n  return <DefaultLoading logoUrl={logoUrl} />;\n}\n","// ============================================================\n// ProtectedRoute Component - SENIC Auth Package\n// Guards routes and redirects if not authenticated\n// ============================================================\n\nimport { ReactNode } from 'react';\nimport { Navigate } from 'react-router-dom';\nimport { useAuth } from '../hooks/useAuth';\nimport { usePermissions } from '../hooks/usePermissions';\n\ninterface ProtectedRouteProps {\n  /**\n   * Children to render if authenticated\n   */\n  children: ReactNode;\n  /**\n   * Required permission (optional)\n   */\n  requirePermission?: string;\n  /**\n   * Required module (optional)\n   */\n  requireModule?: string;\n  /**\n   * Redirect path if not authenticated (default: redirects to portal)\n   */\n  redirectTo?: string;\n  /**\n   * Custom component to show when not authorized (optional)\n   */\n  UnauthorizedComponent?: React.ComponentType;\n  /**\n   * Custom loading component (optional)\n   */\n  LoadingComponent?: React.ComponentType;\n}\n\n/**\n * Default unauthorized component\n */\nfunction DefaultUnauthorized() {\n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-gray-50\">\n      <div className=\"bg-white rounded-lg border shadow-lg p-8 max-w-md text-center\">\n        <h1 className=\"text-xl font-semibold text-gray-800 mb-2\">Access Denied</h1>\n        <p className=\"text-gray-600\">You don't have permission to access this resource.</p>\n      </div>\n    </div>\n  );\n}\n\n/**\n * Default loading component\n */\nfunction DefaultLoading() {\n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-gray-50\">\n      <div className=\"text-center\">\n        <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto\"></div>\n        <p className=\"text-gray-600 mt-4\">Loading...</p>\n      </div>\n    </div>\n  );\n}\n\n/**\n * ProtectedRoute component - guards routes based on authentication and permissions\n */\nexport function ProtectedRoute({\n  children,\n  requirePermission,\n  requireModule,\n  redirectTo,\n  UnauthorizedComponent,\n  LoadingComponent,\n}: ProtectedRouteProps) {\n  const { isAuthenticated, isLoading, loginViaPortal } = useAuth();\n  const { hasPermission, hasModule } = usePermissions();\n\n  // Show loading state\n  if (isLoading) {\n    if (LoadingComponent) {\n      return <LoadingComponent />;\n    }\n    return <DefaultLoading />;\n  }\n\n  // Not authenticated - redirect to portal or custom path\n  if (!isAuthenticated) {\n    if (redirectTo) {\n      return <Navigate to={redirectTo} replace />;\n    }\n    // Redirect to portal\n    loginViaPortal();\n    return null;\n  }\n\n  // Check permission if required\n  if (requirePermission && !hasPermission(requirePermission)) {\n    if (UnauthorizedComponent) {\n      return <UnauthorizedComponent />;\n    }\n    return <DefaultUnauthorized />;\n  }\n\n  // Check module if required\n  if (requireModule && !hasModule(requireModule)) {\n    if (UnauthorizedComponent) {\n      return <UnauthorizedComponent />;\n    }\n    return <DefaultUnauthorized />;\n  }\n\n  // All checks passed - render children\n  return <>{children}</>;\n}\n","// ============================================================\n// UpgradePrompt Component - SENIC Auth Package\n// Shows upgrade message when feature is not available\n// ============================================================\n\nimport { ReactNode } from 'react';\nimport { useSubscription } from '../hooks/useSubscription';\n\ninterface UpgradePromptProps {\n  /**\n   * Required feature to check\n   */\n  feature: string;\n  /**\n   * Children to render if feature is available\n   */\n  children: ReactNode;\n  /**\n   * Custom upgrade component (optional)\n   */\n  UpgradeComponent?: React.ComponentType<{ feature: string; currentPlan: string }>;\n  /**\n   * Upgrade URL (optional)\n   */\n  upgradeUrl?: string;\n  /**\n   * Custom message (optional)\n   */\n  message?: string;\n}\n\n/**\n * Default upgrade component\n */\nfunction DefaultUpgrade({\n  feature,\n  currentPlan,\n  upgradeUrl,\n  message,\n}: {\n  feature: string;\n  currentPlan: string;\n  upgradeUrl?: string;\n  message?: string;\n}) {\n  const defaultMessage = message || `Upgrade your plan to access ${feature}`;\n\n  return (\n    <div className=\"bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-6 text-center\">\n      <div className=\"text-blue-600 mb-2\">\n        <svg\n          className=\"w-12 h-12 mx-auto\"\n          fill=\"none\"\n          stroke=\"currentColor\"\n          viewBox=\"0 0 24 24\"\n        >\n          <path\n            strokeLinecap=\"round\"\n            strokeLinejoin=\"round\"\n            strokeWidth={2}\n            d=\"M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z\"\n          />\n        </svg>\n      </div>\n      <h3 className=\"text-lg font-semibold text-gray-800 mb-2\">Feature Locked</h3>\n      <p className=\"text-gray-600 mb-4\">{defaultMessage}</p>\n      <p className=\"text-sm text-gray-500 mb-4\">Current plan: {currentPlan}</p>\n      {upgradeUrl && (\n        <a\n          href={upgradeUrl}\n          className=\"inline-block px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors\"\n        >\n          Upgrade Now\n        </a>\n      )}\n    </div>\n  );\n}\n\n/**\n * UpgradePrompt component - shows upgrade message if feature is not available\n */\nexport function UpgradePrompt({\n  feature,\n  children,\n  UpgradeComponent,\n  upgradeUrl,\n  message,\n}: UpgradePromptProps) {\n  const { hasFeature, plan } = useSubscription();\n\n  // Feature is available - render children\n  if (hasFeature(feature)) {\n    return <>{children}</>;\n  }\n\n  // Feature not available - show upgrade prompt\n  if (UpgradeComponent) {\n    return <UpgradeComponent feature={feature} currentPlan={plan || 'free'} />;\n  }\n\n  return (\n    <DefaultUpgrade\n      feature={feature}\n      currentPlan={plan || 'free'}\n      upgradeUrl={upgradeUrl}\n      message={message}\n    />\n  );\n}\n"],"names":["_config","initConfig","config","getStorageType","getConfig","getEdgeFunctionsUrl","buildAuthPortalUrl","state","redirectUri","url","redirectToAuthPortal","generateState","storeAuthState","authUrl","parseCallbackHash","hash","params","getStorage","generateFingerprint","str","i","char","storeToken","token","fingerprint","boundToken","getToken","stored","clearToken","parseJwtPayload","base64","jsonPayload","c","isTokenExpired","getCurrentUser","payload","getAuthState","clearAuthState","verifyState","savedState","refreshTokenFromServer","edgeFunctionsUrl","appId","currentToken","response","data","error","validateSessionWithServer","reason","errorData","AuthContext","createContext","useAuth","context","useContext","mapRoleLevelToRole","level","mapSubscriptionPlan","plan","mapSubscriptionStatus","status","SenicAuthProvider","children","portalUrl","supabaseUrl","callbackPath","storageType","onLogout","user","setUser","useState","isLoading","setIsLoading","buildUser","masterAuthUser","refreshAuth","validateSession","valid","shouldClear","handleVerifiedParam","useEffect","interval","value","jsx","useSubscription","isAuthenticated","hasFeature","feature","checkLimit","limitKey","currentValue","limit","isActive","usePermissions","hasPermission","permission","hasModule","module","canAccess","hasRequiredPermission","isAdminLevel","isSuperAdmin","usePlatformAdmin","DefaultLoading","logoUrl","jsxs","DefaultError","onRetry","AuthCallback","redirectTo","errorRedirectTo","LoadingComponent","ErrorComponent","navigate","useNavigate","setError","accessToken","callbackError","err","handleRetry","DefaultUnauthorized","ProtectedRoute","requirePermission","requireModule","UnauthorizedComponent","loginViaPortal","Navigate","DefaultUpgrade","currentPlan","upgradeUrl","message","defaultMessage","UpgradePrompt","UpgradeComponent"],"mappings":"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"}