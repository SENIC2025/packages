{"version":3,"file":"index.mjs","sources":["../src/config.ts","../src/utils/token.ts","../src/context/AuthContext.tsx","../src/hooks/useSubscription.ts","../src/hooks/usePermissions.ts","../src/hooks/usePlatformAdmin.ts","../src/components/AuthCallback.tsx","../src/components/ProtectedRoute.tsx","../src/components/UpgradePrompt.tsx"],"sourcesContent":["// ============================================================\n// Configuration - SENIC Auth Package\n// ============================================================\n\nimport { SenicAuthConfig } from './utils/types';\nimport { generateState, storeAuthState } from './utils/token';\n\nlet _config: SenicAuthConfig | null = null;\n\n/**\n * Initialize SENIC Auth configuration\n */\nexport function initConfig(config: SenicAuthConfig): void {\n  _config = {\n    ...config,\n    callbackPath: config.callbackPath || '/auth/callback',\n    storageType: config.storageType || 'local',\n  };\n}\n\n/**\n * Get configured storage type\n */\nexport function getStorageType(): 'local' | 'session' {\n  const config = getConfig();\n  return config.storageType || 'local';\n}\n\n/**\n * Get current configuration\n */\nexport function getConfig(): SenicAuthConfig {\n  if (!_config) {\n    throw new Error('[SENIC Auth] Configuration not initialized. Wrap your app with <SenicAuthProvider>');\n  }\n  return _config;\n}\n\n/**\n * Get Edge Functions URL from Supabase root URL\n * Package internally appends /functions/v1\n */\nexport function getEdgeFunctionsUrl(): string {\n  const config = getConfig();\n  return `${config.supabaseUrl}/functions/v1`;\n}\n\n/**\n * Build the redirect URL to auth portal\n */\nexport function buildAuthPortalUrl(state: string): string {\n  const config = getConfig();\n  const redirectUri = `${window.location.origin}${config.callbackPath}`;\n\n  const url = new URL(`${config.portalUrl}/login`);\n  url.searchParams.set('app', config.appId);\n  url.searchParams.set('redirect_uri', redirectUri);\n  url.searchParams.set('state', state);\n\n  return url.toString();\n}\n\n/**\n * Redirect to auth portal for login\n */\nexport function redirectToAuthPortal(): void {\n  const state = generateState();\n  storeAuthState(state);\n\n  const authUrl = buildAuthPortalUrl(state);\n  window.location.href = authUrl;\n}\n\n/**\n * Parse hash params from callback URL\n */\nexport function parseCallbackHash(): {\n  accessToken: string | null;\n  state: string | null;\n  error: string | null;\n} {\n  const hash = window.location.hash.substring(1);\n  const params = new URLSearchParams(hash);\n\n  return {\n    accessToken: params.get('access_token'),\n    state: params.get('state'),\n    error: params.get('error'),\n  };\n}\n","// ============================================================\n// Token Management - SENIC Auth Package\n// Handles secure token storage with browser fingerprinting\n// ============================================================\n\nimport { MasterAuthToken } from './types';\nimport { getStorageType } from '../config';\n\n/**\n * Get the appropriate storage based on configuration\n */\nfunction getStorage(): Storage {\n  return getStorageType() === 'session' ? sessionStorage : localStorage;\n}\n\n/**\n * Generate browser fingerprint for token binding\n * SECURITY: Binds token to this specific browser instance\n */\nfunction generateFingerprint(): string {\n  const components = [\n    navigator.userAgent,\n    navigator.language,\n    screen.width + 'x' + screen.height,\n    screen.colorDepth,\n    Intl.DateTimeFormat().resolvedOptions().timeZone,\n    navigator.hardwareConcurrency || 0,\n  ];\n\n  // Simple hash function\n  const str = components.join('|');\n  let hash = 0;\n  for (let i = 0; i < str.length; i++) {\n    const char = str.charCodeAt(i);\n    hash = ((hash << 5) - hash) + char;\n    hash = hash & hash; // Convert to 32bit integer\n  }\n  return hash.toString(36);\n}\n\n/**\n * Store Master Auth token with browser binding\n * SECURITY:\n * - Storage type configurable (localStorage or sessionStorage)\n * - Fingerprint binding: token only valid in this browser\n */\nexport function storeToken(token: string): void {\n  const fingerprint = generateFingerprint();\n  const boundToken = JSON.stringify({ token, fingerprint });\n  getStorage().setItem('senic_auth_token', boundToken);\n}\n\n/**\n * Get stored Master Auth token (with fingerprint verification)\n * Returns null if fingerprint doesn't match (stolen token detection)\n */\nexport function getToken(): string | null {\n  const storage = getStorage();\n  const stored = storage.getItem('senic_auth_token');\n  if (!stored) return null;\n\n  try {\n    const { token, fingerprint } = JSON.parse(stored);\n\n    // SECURITY: Verify token was issued to this browser\n    if (fingerprint !== generateFingerprint()) {\n      console.warn('[SENIC Auth] Token fingerprint mismatch - possible token theft');\n      clearToken();\n      return null;\n    }\n\n    return token;\n  } catch {\n    // Invalid format - clear it\n    clearToken();\n    return null;\n  }\n}\n\n/**\n * Clear Master Auth token\n */\nexport function clearToken(): void {\n  // Clear from both storages to handle storage type changes\n  localStorage.removeItem('senic_auth_token');\n  sessionStorage.removeItem('senic_auth_token');\n}\n\n/**\n * Parse JWT payload (without verification - already verified by edge function)\n */\nexport function parseJwtPayload(token: string): MasterAuthToken | null {\n  try {\n    const base64Url = token.split('.')[1];\n    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');\n    const jsonPayload = decodeURIComponent(\n      atob(base64)\n        .split('')\n        .map((c) => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))\n        .join('')\n    );\n    return JSON.parse(jsonPayload);\n  } catch {\n    return null;\n  }\n}\n\n/**\n * Check if token is expired\n */\nexport function isTokenExpired(token: MasterAuthToken): boolean {\n  return token.exp * 1000 < Date.now();\n}\n\n/**\n * Get current user from stored token\n */\nexport function getCurrentUser(): MasterAuthToken | null {\n  const token = getToken();\n  if (!token) return null;\n\n  const payload = parseJwtPayload(token);\n  if (!payload) return null;\n\n  if (isTokenExpired(payload)) {\n    clearToken();\n    return null;\n  }\n\n  return payload;\n}\n\n/**\n * Generate a random state for CSRF protection\n */\nexport function generateState(): string {\n  return crypto.randomUUID();\n}\n\n/**\n * Store auth state for CSRF verification\n * Uses same storage as token (localStorage or sessionStorage based on config)\n */\nexport function storeAuthState(state: string): void {\n  // Use same storage as token for consistency\n  getStorage().setItem('senic_auth_state', state);\n}\n\n/**\n * Get stored auth state\n */\nexport function getAuthState(): string | null {\n  return getStorage().getItem('senic_auth_state');\n}\n\n/**\n * Clear auth state from storage\n */\nexport function clearAuthState(): void {\n  // Clear from both storages to handle storage type changes\n  localStorage.removeItem('senic_auth_state');\n  sessionStorage.removeItem('senic_auth_state');\n}\n\n/**\n * Verify state matches what we stored (CSRF protection)\n */\nexport function verifyState(state: string | null): boolean {\n  const savedState = getAuthState();\n  return state === savedState;\n}\n\n/**\n * Refresh token by calling exchange-token endpoint\n * Used when user verifies email and needs updated claims\n */\nexport async function refreshTokenFromServer(\n  edgeFunctionsUrl: string,\n  appId: string\n): Promise<boolean> {\n  const currentToken = getToken();\n  if (!currentToken) {\n    console.warn('[SENIC Auth] No token to refresh');\n    return false;\n  }\n\n  try {\n    const response = await fetch(`${edgeFunctionsUrl}/exchange-token`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'Authorization': `Bearer ${currentToken}`,\n      },\n      body: JSON.stringify({ app_id: appId }),\n    });\n\n    if (!response.ok) {\n      console.error('[SENIC Auth] Token refresh failed:', response.status);\n      return false;\n    }\n\n    const data = await response.json();\n    if (data.access_token) {\n      storeToken(data.access_token);\n      console.log('[SENIC Auth] Token refreshed successfully');\n      return true;\n    }\n\n    return false;\n  } catch (error) {\n    console.error('[SENIC Auth] Token refresh error:', error);\n    return false;\n  }\n}\n\n/**\n * Validate session with server\n * SECURITY: Called on app mount to ensure user still exists in database\n * Catches: deleted users, revoked access, deactivated accounts, force logout\n */\nexport async function validateSessionWithServer(\n  edgeFunctionsUrl: string,\n  appId: string\n): Promise<{ valid: boolean; shouldClear: boolean; reason?: string }> {\n  const currentToken = getToken();\n  if (!currentToken) {\n    // No token = not logged in (valid state, no need to clear)\n    return { valid: false, shouldClear: false };\n  }\n\n  try {\n    const response = await fetch(`${edgeFunctionsUrl}/exchange-token`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'Authorization': `Bearer ${currentToken}`,\n      },\n      body: JSON.stringify({ app_id: appId }),\n    });\n\n    if (!response.ok) {\n      // Parse error to get specific reason\n      let reason = 'unknown';\n      try {\n        const errorData = await response.json();\n        reason = errorData.error || 'unknown';\n\n        // Handle specific error codes\n        if (errorData.error === 'force_logout') {\n          console.warn('[SENIC Auth] Force logout triggered by admin - clearing token');\n          return { valid: false, shouldClear: true, reason: 'force_logout' };\n        }\n      } catch {\n        // Failed to parse error response\n      }\n\n      console.warn(`[SENIC Auth] Session validation failed (${reason}) - clearing token`);\n      return { valid: false, shouldClear: true, reason };\n    }\n\n    const data = await response.json();\n    if (data.access_token) {\n      // Refresh the token while we're at it (get latest claims)\n      storeToken(data.access_token);\n      return { valid: true, shouldClear: false };\n    }\n\n    return { valid: false, shouldClear: true, reason: 'no_token_returned' };\n  } catch (error) {\n    // Network error - don't clear token (might be offline)\n    console.warn('[SENIC Auth] Session validation network error:', error);\n    return { valid: true, shouldClear: false };\n  }\n}\n","// ============================================================\n// Auth Context - SENIC Auth Package\n// Main authentication provider with user state management\n// ============================================================\n\nimport { createContext, useContext, useState, useEffect, ReactNode } from 'react';\nimport { SenicUser, SenicAuthConfig, UserRole, SubscriptionPlan, SubscriptionStatus, StorageType } from '../utils/types';\nimport { getCurrentUser, clearToken, refreshTokenFromServer, validateSessionWithServer } from '../utils/token';\nimport { initConfig, redirectToAuthPortal, getEdgeFunctionsUrl, getConfig } from '../config';\n\n// ============================================================\n// Types\n// ============================================================\n\ninterface AuthContextType {\n  user: SenicUser | null;\n  isAuthenticated: boolean;\n  isLoading: boolean;\n  logout: () => void;\n  loginViaPortal: () => void;\n  refreshAuth: () => void;\n}\n\n// ============================================================\n// Context\n// ============================================================\n\nconst AuthContext = createContext<AuthContextType | undefined>(undefined);\n\n/**\n * Hook to access auth context\n */\nexport function useAuth(): AuthContextType {\n  const context = useContext(AuthContext);\n  if (!context) {\n    throw new Error('useAuth must be used within a SenicAuthProvider');\n  }\n  return context;\n}\n\n// ============================================================\n// Helpers\n// ============================================================\n\n/**\n * Map role level to UserRole enum\n * Levels: super_admin=100, admin=80, manager=60, editor=40, member=20, viewer=10\n */\nfunction mapRoleLevelToRole(level: number): UserRole {\n  if (level >= 100) return 'super_admin';\n  if (level >= 80) return 'admin';\n  if (level >= 60) return 'manager';\n  if (level >= 40) return 'editor';\n  if (level >= 20) return 'member';\n  return 'viewer';\n}\n\n/**\n * Map subscription plan string to typed enum\n */\nfunction mapSubscriptionPlan(plan: string): SubscriptionPlan {\n  const validPlans: SubscriptionPlan[] = ['starter', 'professional', 'business', 'enterprise'];\n  return validPlans.includes(plan as SubscriptionPlan)\n    ? (plan as SubscriptionPlan)\n    : 'starter';\n}\n\n/**\n * Map subscription status string to typed enum\n */\nfunction mapSubscriptionStatus(status: string): SubscriptionStatus {\n  const validStatuses: SubscriptionStatus[] = ['active', 'trialing', 'past_due', 'canceled', 'incomplete'];\n  return validStatuses.includes(status as SubscriptionStatus)\n    ? (status as SubscriptionStatus)\n    : 'active';\n}\n\n// ============================================================\n// Provider\n// ============================================================\n\ninterface SenicAuthProviderProps {\n  children: ReactNode;\n  appId: string;\n  portalUrl: string;\n  supabaseUrl: string;\n  callbackPath?: string;\n  storageType?: StorageType; // 'local' (default) or 'session' (for banking/payment apps)\n  onLogout?: () => void;\n}\n\nexport function SenicAuthProvider({\n  children,\n  appId,\n  portalUrl,\n  supabaseUrl,\n  callbackPath,\n  storageType,\n  onLogout,\n}: SenicAuthProviderProps): JSX.Element {\n  // Initialize config SYNCHRONOUSLY before any hooks run\n  // This ensures config is ready before AuthCallback or any other component tries to use it\n  // Previously this was in useEffect which caused a race condition on callback page\n  const configRef = { appId, portalUrl, supabaseUrl, callbackPath, storageType };\n  initConfig(configRef);\n\n  const [user, setUser] = useState<SenicUser | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n\n  /**\n   * Build SenicUser from MasterAuthToken\n   * Field names must match what exchange-token edge function returns\n   */\n  const buildUser = (masterAuthUser: ReturnType<typeof getCurrentUser>): SenicUser | null => {\n    if (!masterAuthUser) return null;\n\n    return {\n      id: masterAuthUser.sub,\n      email: masterAuthUser.email,\n      name: masterAuthUser.full_name || masterAuthUser.email.split('@')[0],\n      displayName: masterAuthUser.full_name || masterAuthUser.email.split('@')[0],\n      avatarUrl: masterAuthUser.avatar_url,\n      organizationId: masterAuthUser.organization_id,\n      organizationName: masterAuthUser.organization_name,\n      organizationSlug: masterAuthUser.organization_slug,\n      role: mapRoleLevelToRole(masterAuthUser.app_role_level),\n      roleLevel: masterAuthUser.app_role_level,\n      isOwner: masterAuthUser.is_owner,\n      permissions: masterAuthUser.permissions || [],\n      enabledModules: masterAuthUser.enabled_modules || [],\n      subscriptionPlan: mapSubscriptionPlan(masterAuthUser.subscription_plan),\n      subscriptionStatus: mapSubscriptionStatus(masterAuthUser.subscription_status),\n      planFeatures: masterAuthUser.plan_features || [],\n      planLimits: masterAuthUser.plan_limits || {},\n      isPlatformAdmin: masterAuthUser.is_platform_admin || false,\n    };\n  };\n\n  /**\n   * Refresh auth state from stored token (local only, no server call)\n   */\n  const refreshAuth = () => {\n    try {\n      const masterAuthUser = getCurrentUser();\n      setUser(buildUser(masterAuthUser));\n    } catch (error) {\n      console.error('[SENIC Auth] Error refreshing auth:', error);\n      setUser(null);\n    }\n  };\n\n  /**\n   * Validate session with server on mount\n   * SECURITY: Ensures user still exists in database (catches deleted/revoked users)\n   */\n  const validateSession = async () => {\n    try {\n      const config = getConfig();\n      const edgeFunctionsUrl = getEdgeFunctionsUrl();\n\n      const { valid, shouldClear, reason } = await validateSessionWithServer(edgeFunctionsUrl, config.appId);\n\n      if (shouldClear) {\n        console.log(`[SENIC Auth] Session invalid (${reason}) - clearing and redirecting to login`);\n        clearToken();\n        setUser(null);\n      } else if (valid) {\n        // Refresh user from potentially updated token\n        const masterAuthUser = getCurrentUser();\n        setUser(buildUser(masterAuthUser));\n      }\n    } catch (error) {\n      console.error('[SENIC Auth] Session validation error:', error);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  /**\n   * Handle ?verified=true - refresh token to get updated claims\n   */\n  const handleVerifiedParam = async () => {\n    const urlParams = new URLSearchParams(window.location.search);\n    const verified = urlParams.get('verified');\n\n    if (verified === 'true') {\n      console.log('[SENIC Auth] Detected ?verified=true - refreshing token for updated claims');\n\n      // Clean URL by removing the param\n      const url = new URL(window.location.href);\n      url.searchParams.delete('verified');\n      window.history.replaceState({}, '', url.toString());\n\n      // Refresh token from server to get updated claims (e.g., is_verified = true)\n      try {\n        const config = getConfig();\n        const edgeFunctionsUrl = getEdgeFunctionsUrl();\n        const success = await refreshTokenFromServer(edgeFunctionsUrl, config.appId);\n\n        if (success) {\n          // Reload user from new token\n          const masterAuthUser = getCurrentUser();\n          setUser(buildUser(masterAuthUser));\n          console.log('[SENIC Auth] Token refreshed with updated claims');\n        }\n      } catch (error) {\n        console.error('[SENIC Auth] Failed to refresh token after verification:', error);\n      }\n    }\n  };\n\n  // Initialize on mount - validate session with server\n  useEffect(() => {\n    // First do a quick local check to show UI faster\n    refreshAuth();\n\n    // Then validate with server (catches deleted/revoked users)\n    validateSession();\n\n    // Handle ?verified=true if present\n    handleVerifiedParam();\n  }, []);\n\n  // Periodic session validation (heartbeat)\n  // SECURITY: Catches deleted users, revoked tokens, and breaking changes\n  // even when user leaves browser tab open for extended periods\n  useEffect(() => {\n    const HEARTBEAT_INTERVAL = 15 * 60 * 1000; // 15 minutes\n\n    const interval = setInterval(() => {\n      // Only validate if user appears to be logged in\n      if (user) {\n        console.log('[SENIC Auth] Heartbeat - validating session');\n        validateSession();\n      }\n    }, HEARTBEAT_INTERVAL);\n\n    return () => clearInterval(interval);\n  }, [user]);\n\n  /**\n   * Redirect to auth portal for login\n   */\n  const loginViaPortal = () => {\n    redirectToAuthPortal();\n  };\n\n  /**\n   * Logout - clear token and optionally redirect\n   */\n  const logout = () => {\n    clearToken();\n    setUser(null);\n\n    // Call custom logout handler if provided\n    if (onLogout) {\n      onLogout();\n    } else {\n      // Default: redirect to portal\n      setTimeout(() => {\n        redirectToAuthPortal();\n      }, 500);\n    }\n  };\n\n  const value: AuthContextType = {\n    user,\n    isAuthenticated: !!user,\n    isLoading,\n    logout,\n    loginViaPortal,\n    refreshAuth,\n  };\n\n  return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;\n}\n","// ============================================================\n// useSubscription Hook - SENIC Auth Package\n// Access subscription plan, features, and limits\n// ============================================================\n\nimport { useAuth } from '../context/AuthContext';\nimport { SubscriptionPlan, SubscriptionStatus } from '../utils/types';\n\nexport interface UseSubscriptionReturn {\n  plan: SubscriptionPlan | null;\n  status: SubscriptionStatus | null;\n  features: string[];\n  limits: Record<string, number>;\n  hasFeature: (feature: string) => boolean;\n  checkLimit: (limitKey: string, currentValue: number) => boolean;\n  isActive: boolean;\n}\n\n/**\n * Hook to access subscription information\n */\nexport function useSubscription(): UseSubscriptionReturn {\n  const { user, isAuthenticated } = useAuth();\n\n  if (!isAuthenticated || !user) {\n    return {\n      plan: null,\n      status: null,\n      features: [],\n      limits: {},\n      hasFeature: () => false,\n      checkLimit: () => false,\n      isActive: false,\n    };\n  }\n\n  /**\n   * Check if user has a specific feature\n   */\n  const hasFeature = (feature: string): boolean => {\n    return user.planFeatures.includes(feature);\n  };\n\n  /**\n   * Check if current value is within limit\n   * Returns true if within limit or no limit exists\n   */\n  const checkLimit = (limitKey: string, currentValue: number): boolean => {\n    const limit = user.planLimits[limitKey];\n    if (limit === undefined || limit === null) return true; // No limit = unlimited\n    if (limit === -1) return true; // -1 = unlimited\n    return currentValue < limit;\n  };\n\n  /**\n   * Check if subscription is active\n   */\n  const isActive = user.subscriptionStatus === 'active' || user.subscriptionStatus === 'trialing';\n\n  return {\n    plan: user.subscriptionPlan,\n    status: user.subscriptionStatus,\n    features: user.planFeatures,\n    limits: user.planLimits,\n    hasFeature,\n    checkLimit,\n    isActive,\n  };\n}\n","// ============================================================\n// usePermissions Hook - SENIC Auth Package\n// Access permissions, modules, and role information\n// ============================================================\n\nimport { useAuth } from '../context/AuthContext';\nimport { UserRole } from '../utils/types';\n\nexport interface UsePermissionsReturn {\n  permissions: string[];\n  modules: string[];\n  role: UserRole | null;\n  roleLevel: number;\n  isOwner: boolean;\n  hasPermission: (permission: string) => boolean;\n  hasModule: (module: string) => boolean;\n  canAccess: (permission: string, module?: string) => boolean;\n  isAdminLevel: boolean;\n  isSuperAdmin: boolean;\n}\n\n/**\n * Hook to access permissions and role information\n */\nexport function usePermissions(): UsePermissionsReturn {\n  const { user, isAuthenticated } = useAuth();\n\n  if (!isAuthenticated || !user) {\n    return {\n      permissions: [],\n      modules: [],\n      role: null,\n      roleLevel: 100,\n      isOwner: false,\n      hasPermission: () => false,\n      hasModule: () => false,\n      canAccess: () => false,\n      isAdminLevel: false,\n      isSuperAdmin: false,\n    };\n  }\n\n  /**\n   * Check if user has a specific permission\n   */\n  const hasPermission = (permission: string): boolean => {\n    // Owners and super_admins have all permissions\n    if (user.isOwner || user.role === 'super_admin') return true;\n    return user.permissions.includes(permission);\n  };\n\n  /**\n   * Check if user has access to a specific module\n   */\n  const hasModule = (module: string): boolean => {\n    // Owners and super_admins have all modules\n    if (user.isOwner || user.role === 'super_admin') return true;\n    return user.enabledModules.includes(module);\n  };\n\n  /**\n   * Check if user can access a resource (permission + optional module)\n   */\n  const canAccess = (permission: string, module?: string): boolean => {\n    const hasRequiredPermission = hasPermission(permission);\n    if (!module) return hasRequiredPermission;\n    return hasRequiredPermission && hasModule(module);\n  };\n\n  /**\n   * Check if user is admin level (admin or super_admin)\n   */\n  const isAdminLevel = user.role === 'admin' || user.role === 'super_admin';\n\n  /**\n   * Check if user is super admin\n   */\n  const isSuperAdmin = user.role === 'super_admin';\n\n  return {\n    permissions: user.permissions,\n    modules: user.enabledModules,\n    role: user.role,\n    roleLevel: user.roleLevel,\n    isOwner: user.isOwner,\n    hasPermission,\n    hasModule,\n    canAccess,\n    isAdminLevel,\n    isSuperAdmin,\n  };\n}\n","// ============================================================\n// Platform Admin Hook - SENIC Auth Package\n// ============================================================\n\nimport { useAuth } from '../context/AuthContext';\n\n/**\n * Hook to check if current user is a Platform Admin\n *\n * Platform Admin = super_admin role (level 100) + member of 'senic' organization\n *\n * Uses the is_platform_admin claim from JWT which is set by the\n * custom_access_token_hook in Master Auth database.\n */\nexport function usePlatformAdmin() {\n  const { user, isLoading } = useAuth();\n\n  return {\n    /** Whether the current user is a platform admin */\n    isPlatformAdmin: user?.isPlatformAdmin ?? false,\n    /** Whether authentication is still loading */\n    isLoading,\n    /** Current user object */\n    user,\n  };\n}\n\nexport type UsePlatformAdminReturn = ReturnType<typeof usePlatformAdmin>;\n","// ============================================================\n// AuthCallback Component - SENIC Auth Package\n// Handles redirect from Master Auth Portal\n// ============================================================\n\nimport { useEffect, useState } from 'react';\nimport { useNavigate } from 'react-router-dom';\nimport { useAuth } from '../hooks/useAuth';\nimport {\n  parseJwtPayload,\n  storeToken,\n  isTokenExpired,\n  verifyState,\n  clearAuthState,\n} from '../utils/token';\nimport { parseCallbackHash } from '../config';\n\ninterface AuthCallbackProps {\n  /**\n   * Custom logo URL (optional)\n   */\n  logoUrl?: string;\n  /**\n   * Custom redirect path after successful auth (default: '/')\n   */\n  redirectTo?: string;\n  /**\n   * Custom error redirect path (default: '/login')\n   */\n  errorRedirectTo?: string;\n  /**\n   * Custom loading component\n   */\n  LoadingComponent?: React.ComponentType;\n  /**\n   * Custom error component\n   */\n  ErrorComponent?: React.ComponentType<{ error: string; onRetry: () => void }>;\n}\n\n/**\n * Default loading component\n */\nfunction DefaultLoading({ logoUrl }: { logoUrl?: string }) {\n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-gray-50\">\n      <div className=\"text-center\">\n        {logoUrl && (\n          <img\n            src={logoUrl}\n            alt=\"Logo\"\n            className=\"h-16 mx-auto mb-4 animate-pulse\"\n          />\n        )}\n        <p className=\"text-gray-600\">Completing authentication...</p>\n      </div>\n    </div>\n  );\n}\n\n/**\n * Default error component\n */\nfunction DefaultError({ error, onRetry }: { error: string; onRetry: () => void }) {\n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-gray-50\">\n      <div className=\"bg-white rounded-lg border shadow-lg p-8 max-w-md text-center\">\n        <h1 className=\"text-xl font-semibold text-gray-800 mb-2\">Authentication Failed</h1>\n        <p className=\"text-gray-600 mb-6\">{error}</p>\n        <button\n          onClick={onRetry}\n          className=\"w-full px-4 py-3 rounded-lg font-medium text-white bg-blue-600 hover:bg-blue-700 transition-colors\"\n        >\n          Back to Login\n        </button>\n      </div>\n    </div>\n  );\n}\n\n/**\n * AuthCallback component - handles OAuth callback\n */\nexport function AuthCallback({\n  logoUrl,\n  redirectTo = '/',\n  errorRedirectTo = '/login',\n  LoadingComponent,\n  ErrorComponent,\n}: AuthCallbackProps) {\n  const navigate = useNavigate();\n  const { refreshAuth } = useAuth();\n  const [error, setError] = useState<string | null>(null);\n\n  useEffect(() => {\n    const handleCallback = async () => {\n      try {\n        // Parse hash params\n        const { accessToken, state, error: callbackError } = parseCallbackHash();\n\n        // Check for errors\n        if (callbackError) {\n          throw new Error(callbackError);\n        }\n\n        // Verify we have a token\n        if (!accessToken) {\n          throw new Error('No access token received');\n        }\n\n        // Verify state (CSRF protection)\n        if (!verifyState(state)) {\n          throw new Error('Invalid state parameter - possible CSRF attack');\n        }\n\n        // Parse and validate token\n        const payload = parseJwtPayload(accessToken);\n        if (!payload) {\n          throw new Error('Invalid token format');\n        }\n\n        if (isTokenExpired(payload)) {\n          throw new Error('Token has expired');\n        }\n\n        // Verify it's a Master Auth token\n        if (!payload.master_auth) {\n          throw new Error('Invalid token - not from Master Auth');\n        }\n\n        // Store the token\n        storeToken(accessToken);\n\n        // Clear auth state\n        clearAuthState();\n\n        // Clear the hash from URL (security)\n        window.history.replaceState(null, '', window.location.pathname);\n\n        // Refresh AuthContext to pick up the new token\n        refreshAuth();\n\n        // Navigate to destination\n        navigate(redirectTo, { replace: true });\n      } catch (err) {\n        console.error('[SENIC Auth] Callback error:', err);\n        setError(err instanceof Error ? err.message : 'Authentication failed');\n        clearAuthState();\n      }\n    };\n\n    handleCallback();\n  }, [navigate, refreshAuth, redirectTo]);\n\n  const handleRetry = () => {\n    navigate(errorRedirectTo, { replace: true });\n  };\n\n  if (error) {\n    if (ErrorComponent) {\n      return <ErrorComponent error={error} onRetry={handleRetry} />;\n    }\n    return <DefaultError error={error} onRetry={handleRetry} />;\n  }\n\n  if (LoadingComponent) {\n    return <LoadingComponent />;\n  }\n\n  return <DefaultLoading logoUrl={logoUrl} />;\n}\n","// ============================================================\n// ProtectedRoute Component - SENIC Auth Package\n// Guards routes and redirects if not authenticated\n// ============================================================\n\nimport { ReactNode } from 'react';\nimport { Navigate } from 'react-router-dom';\nimport { useAuth } from '../hooks/useAuth';\nimport { usePermissions } from '../hooks/usePermissions';\n\ninterface ProtectedRouteProps {\n  /**\n   * Children to render if authenticated\n   */\n  children: ReactNode;\n  /**\n   * Required permission (optional)\n   */\n  requirePermission?: string;\n  /**\n   * Required module (optional)\n   */\n  requireModule?: string;\n  /**\n   * Redirect path if not authenticated (default: redirects to portal)\n   */\n  redirectTo?: string;\n  /**\n   * Custom component to show when not authorized (optional)\n   */\n  UnauthorizedComponent?: React.ComponentType;\n  /**\n   * Custom loading component (optional)\n   */\n  LoadingComponent?: React.ComponentType;\n}\n\n/**\n * Default unauthorized component\n */\nfunction DefaultUnauthorized() {\n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-gray-50\">\n      <div className=\"bg-white rounded-lg border shadow-lg p-8 max-w-md text-center\">\n        <h1 className=\"text-xl font-semibold text-gray-800 mb-2\">Access Denied</h1>\n        <p className=\"text-gray-600\">You don't have permission to access this resource.</p>\n      </div>\n    </div>\n  );\n}\n\n/**\n * Default loading component\n */\nfunction DefaultLoading() {\n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-gray-50\">\n      <div className=\"text-center\">\n        <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto\"></div>\n        <p className=\"text-gray-600 mt-4\">Loading...</p>\n      </div>\n    </div>\n  );\n}\n\n/**\n * ProtectedRoute component - guards routes based on authentication and permissions\n */\nexport function ProtectedRoute({\n  children,\n  requirePermission,\n  requireModule,\n  redirectTo,\n  UnauthorizedComponent,\n  LoadingComponent,\n}: ProtectedRouteProps) {\n  const { isAuthenticated, isLoading, loginViaPortal } = useAuth();\n  const { hasPermission, hasModule } = usePermissions();\n\n  // Show loading state\n  if (isLoading) {\n    if (LoadingComponent) {\n      return <LoadingComponent />;\n    }\n    return <DefaultLoading />;\n  }\n\n  // Not authenticated - redirect to portal or custom path\n  if (!isAuthenticated) {\n    if (redirectTo) {\n      return <Navigate to={redirectTo} replace />;\n    }\n    // Redirect to portal\n    loginViaPortal();\n    return null;\n  }\n\n  // Check permission if required\n  if (requirePermission && !hasPermission(requirePermission)) {\n    if (UnauthorizedComponent) {\n      return <UnauthorizedComponent />;\n    }\n    return <DefaultUnauthorized />;\n  }\n\n  // Check module if required\n  if (requireModule && !hasModule(requireModule)) {\n    if (UnauthorizedComponent) {\n      return <UnauthorizedComponent />;\n    }\n    return <DefaultUnauthorized />;\n  }\n\n  // All checks passed - render children\n  return <>{children}</>;\n}\n","// ============================================================\n// UpgradePrompt Component - SENIC Auth Package\n// Shows upgrade message when feature is not available\n// ============================================================\n\nimport { ReactNode } from 'react';\nimport { useSubscription } from '../hooks/useSubscription';\n\ninterface UpgradePromptProps {\n  /**\n   * Required feature to check\n   */\n  feature: string;\n  /**\n   * Children to render if feature is available\n   */\n  children: ReactNode;\n  /**\n   * Custom upgrade component (optional)\n   */\n  UpgradeComponent?: React.ComponentType<{ feature: string; currentPlan: string }>;\n  /**\n   * Upgrade URL (optional)\n   */\n  upgradeUrl?: string;\n  /**\n   * Custom message (optional)\n   */\n  message?: string;\n}\n\n/**\n * Default upgrade component\n */\nfunction DefaultUpgrade({\n  feature,\n  currentPlan,\n  upgradeUrl,\n  message,\n}: {\n  feature: string;\n  currentPlan: string;\n  upgradeUrl?: string;\n  message?: string;\n}) {\n  const defaultMessage = message || `Upgrade your plan to access ${feature}`;\n\n  return (\n    <div className=\"bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-6 text-center\">\n      <div className=\"text-blue-600 mb-2\">\n        <svg\n          className=\"w-12 h-12 mx-auto\"\n          fill=\"none\"\n          stroke=\"currentColor\"\n          viewBox=\"0 0 24 24\"\n        >\n          <path\n            strokeLinecap=\"round\"\n            strokeLinejoin=\"round\"\n            strokeWidth={2}\n            d=\"M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z\"\n          />\n        </svg>\n      </div>\n      <h3 className=\"text-lg font-semibold text-gray-800 mb-2\">Feature Locked</h3>\n      <p className=\"text-gray-600 mb-4\">{defaultMessage}</p>\n      <p className=\"text-sm text-gray-500 mb-4\">Current plan: {currentPlan}</p>\n      {upgradeUrl && (\n        <a\n          href={upgradeUrl}\n          className=\"inline-block px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors\"\n        >\n          Upgrade Now\n        </a>\n      )}\n    </div>\n  );\n}\n\n/**\n * UpgradePrompt component - shows upgrade message if feature is not available\n */\nexport function UpgradePrompt({\n  feature,\n  children,\n  UpgradeComponent,\n  upgradeUrl,\n  message,\n}: UpgradePromptProps) {\n  const { hasFeature, plan } = useSubscription();\n\n  // Feature is available - render children\n  if (hasFeature(feature)) {\n    return <>{children}</>;\n  }\n\n  // Feature not available - show upgrade prompt\n  if (UpgradeComponent) {\n    return <UpgradeComponent feature={feature} currentPlan={plan || 'free'} />;\n  }\n\n  return (\n    <DefaultUpgrade\n      feature={feature}\n      currentPlan={plan || 'free'}\n      upgradeUrl={upgradeUrl}\n      message={message}\n    />\n  );\n}\n"],"names":["_config","initConfig","config","getStorageType","getConfig","getEdgeFunctionsUrl","buildAuthPortalUrl","state","redirectUri","url","redirectToAuthPortal","generateState","storeAuthState","authUrl","parseCallbackHash","hash","params","getStorage","generateFingerprint","str","i","char","storeToken","token","fingerprint","boundToken","getToken","stored","clearToken","parseJwtPayload","base64","jsonPayload","c","isTokenExpired","getCurrentUser","payload","getAuthState","clearAuthState","verifyState","savedState","refreshTokenFromServer","edgeFunctionsUrl","appId","currentToken","response","data","error","validateSessionWithServer","reason","errorData","AuthContext","createContext","useAuth","context","useContext","mapRoleLevelToRole","level","mapSubscriptionPlan","plan","mapSubscriptionStatus","status","SenicAuthProvider","children","portalUrl","supabaseUrl","callbackPath","storageType","onLogout","user","setUser","useState","isLoading","setIsLoading","buildUser","masterAuthUser","refreshAuth","validateSession","valid","shouldClear","handleVerifiedParam","useEffect","interval","value","jsx","useSubscription","isAuthenticated","hasFeature","feature","checkLimit","limitKey","currentValue","limit","isActive","usePermissions","hasPermission","permission","hasModule","module","canAccess","hasRequiredPermission","isAdminLevel","isSuperAdmin","usePlatformAdmin","DefaultLoading","logoUrl","jsxs","DefaultError","onRetry","AuthCallback","redirectTo","errorRedirectTo","LoadingComponent","ErrorComponent","navigate","useNavigate","setError","accessToken","callbackError","err","handleRetry","DefaultUnauthorized","ProtectedRoute","requirePermission","requireModule","UnauthorizedComponent","loginViaPortal","Navigate","DefaultUpgrade","currentPlan","upgradeUrl","message","defaultMessage","UpgradePrompt","UpgradeComponent"],"mappings":"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"}